<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIAL-RL Evaluation Results</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DIAL-RL Evaluation Dashboard</h1>
            <p>Compare questioner model performance on the DIAL benchmark</p>
        </div>

        <div class="instructions">
            <strong>Click on any bar or model card</strong> to view detailed results including pairwise accuracy heatmap and conversation explorer.
        </div>

        <!-- Loading state -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading evaluation data...</p>
        </div>

        <!-- Main content (hidden until loaded) -->
        <div id="main-content" style="display: none;">
            <div class="chart-section">
                <div class="chart-title">Model Accuracy (Calibrated %)</div>
                <div id="accuracy-chart"></div>
            </div>

            <div class="chart-section">
                <div class="chart-title">Question Difficulty Distribution by Model</div>
                <div class="legend">
                    <div class="legend-item">
                        <span class="legend-color too-easy"></span>
                        <span>Too Easy (both correct)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color calibrated"></span>
                        <span>Calibrated (exactly one correct)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color too-hard"></span>
                        <span>Too Hard (both wrong)</span>
                    </div>
                </div>
                <div id="difficulty-chart"></div>
            </div>

            <div class="model-list">
                <h2>Evaluated Models</h2>
                <div id="model-list">
                    <div class="no-data">
                        <p>No models loaded.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store loaded model data
        let modelData = [];

        async function init() {
            try {
                const response = await fetch('data/index.json');
                if (!response.ok) {
                    throw new Error('Could not load index.json');
                }
                const data = await response.json();
                modelData = data.models;

                // Sort by calibrated percentage descending
                modelData.sort((a, b) => b.calibrated_pct - a.calibrated_pct);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';

                updateChart();
                updateModelList();
            } catch (e) {
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <div class="error-icon">&#9888;</div>
                        <p>Failed to load evaluation data: ${e.message}</p>
                    </div>
                `;
            }
        }

        function updateChart() {
            if (modelData.length === 0) {
                document.getElementById('accuracy-chart').innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">&#128202;</div>
                        <p>No evaluation data found.</p>
                    </div>
                `;
                document.getElementById('difficulty-chart').innerHTML = '';
                return;
            }

            // ===== ACCURACY CHART =====
            const accuracyTrace = {
                x: modelData.map(m => m.model_name),
                y: modelData.map(m => m.calibrated_pct),
                type: 'bar',
                marker: {
                    color: modelData.map(m => m.calibrated_pct),
                    colorscale: [
                        [0, '#ffcdd2'],
                        [0.5, '#fff9c4'],
                        [1, '#c8e6c9']
                    ],
                    cmin: 0,
                    cmax: 100
                },
                text: modelData.map(m => `${m.calibrated_pct.toFixed(1)}%`),
                textposition: 'outside',
                hovertemplate: '<b>%{x}</b><br>Calibrated: %{y:.1f}%<extra></extra>'
            };

            const accuracyLayout = {
                height: 400,
                xaxis: {
                    title: 'Model',
                    tickangle: -30
                },
                yaxis: {
                    title: 'Calibrated (%)',
                    range: [0, 30],
                    gridcolor: '#eee'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                margin: { t: 30, b: 120, l: 60, r: 30 },
                hoverlabel: {
                    bgcolor: 'white',
                    bordercolor: '#333'
                }
            };

            Plotly.newPlot('accuracy-chart', [accuracyTrace], accuracyLayout, { responsive: true });

            // Add click handler for accuracy chart
            document.getElementById('accuracy-chart').on('plotly_click', function(data) {
                const modelName = data.points[0].x;
                openModelDetails(modelName);
            });

            // ===== DIFFICULTY DISTRIBUTION CHART =====
            const tooEasyTrace = {
                y: modelData.map(m => m.model_name),
                x: modelData.map(m => m.too_easy_pct),
                name: 'Too Easy',
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: '#ffb74d'
                },
                text: modelData.map(m => m.too_easy_pct > 5 ? `${m.too_easy_pct.toFixed(1)}%` : ''),
                textposition: 'inside',
                insidetextanchor: 'middle',
                textfont: { color: 'white', size: 12 },
                hovertemplate: '<b>%{y}</b><br>Too Easy: %{x:.1f}%<extra></extra>'
            };

            const calibratedTrace = {
                y: modelData.map(m => m.model_name),
                x: modelData.map(m => m.calibrated_pct),
                name: 'Calibrated',
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: '#81c784'
                },
                text: modelData.map(m => m.calibrated_pct > 5 ? `${m.calibrated_pct.toFixed(1)}%` : ''),
                textposition: 'inside',
                insidetextanchor: 'middle',
                textfont: { color: 'white', size: 12 },
                hovertemplate: '<b>%{y}</b><br>Calibrated: %{x:.1f}%<extra></extra>'
            };

            const tooHardTrace = {
                y: modelData.map(m => m.model_name),
                x: modelData.map(m => m.too_hard_pct),
                name: 'Too Hard',
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: '#e57373'
                },
                text: modelData.map(m => m.too_hard_pct > 5 ? `${m.too_hard_pct.toFixed(1)}%` : ''),
                textposition: 'inside',
                insidetextanchor: 'middle',
                textfont: { color: 'white', size: 12 },
                hovertemplate: '<b>%{y}</b><br>Too Hard: %{x:.1f}%<extra></extra>'
            };

            const difficultyLayout = {
                height: Math.max(300, modelData.length * 60 + 80),
                barmode: 'stack',
                xaxis: {
                    title: 'Percentage of Questions',
                    range: [0, 100],
                    gridcolor: '#eee',
                    ticksuffix: '%'
                },
                yaxis: {
                    automargin: true
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                margin: { t: 20, b: 50, l: 150, r: 30 },
                hoverlabel: {
                    bgcolor: 'white',
                    bordercolor: '#333'
                },
                showlegend: false
            };

            Plotly.newPlot('difficulty-chart', [tooEasyTrace, calibratedTrace, tooHardTrace], difficultyLayout, { responsive: true });

            // Add click handler for difficulty chart
            document.getElementById('difficulty-chart').on('plotly_click', function(data) {
                const modelName = data.points[0].y;
                openModelDetails(modelName);
            });
        }

        function updateModelList() {
            const listEl = document.getElementById('model-list');

            if (modelData.length === 0) {
                listEl.innerHTML = `
                    <div class="no-data">
                        <p>No models loaded.</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = modelData.map(m => `
                <div class="model-item" onclick="openModelDetails('${m.model_name}')">
                    <div>
                        <div class="model-name">${m.model_name}</div>
                        <div class="model-details">
                            ${m.total_rollouts} rollouts | ${m.num_pairs} pairs | Answer key: ${m.answer_key_model}
                        </div>
                        <div class="difficulty-breakdown">
                            <span class="too-easy">Too Easy: ${m.too_easy_pct.toFixed(1)}%</span>
                            <span class="calibrated">Calibrated: ${m.calibrated_pct.toFixed(1)}%</span>
                            <span class="too-hard">Too Hard: ${m.too_hard_pct.toFixed(1)}%</span>
                        </div>
                    </div>
                    <div class="model-accuracy">${m.calibrated_pct.toFixed(1)}%</div>
                </div>
            `).join('');
        }

        function openModelDetails(modelName) {
            const model = modelData.find(m => m.model_name === modelName);
            if (model) {
                window.location.href = `eval.html?model=${encodeURIComponent(model.filename)}`;
            }
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
